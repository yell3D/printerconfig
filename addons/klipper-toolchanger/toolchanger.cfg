[gcode_macro ZIGZAG_BRUSH_WIPE]
description: ZIGZAG_BRUSH_WIPE STARTX=237 STARTY=1.5 TIMES=5
  This macro performs a zigzag brush pattern
     STARTX: Starting X position
     STARTY: Starting Y position
     TIMES:   Number of times to repeat the zigzag pattern
     SPEED:   Movement speed in mm/s
     WIDTH:   Brush width (X)
     DEPTH:   Brush depth (Y)
gcode:
  {% set start_x = params.STARTX |default(0)   |int %}
  {% set start_y = params.STARTY |default(0)   |int %}
  {% set loops   = params.TIMES  |default(1)   |int %}
  {% set speed   = params.SPEED  |default(100) |int %}
  {% set depth   = params.DEPTH  |default(7)   |int %}
  {% set width   = params.WIDTH  |default(4)   |int %}

  # ZIGZAG_BRUSH_WIPE STARTX=6 STARTY=1 TIMES=1
  # ZIGZAG_BRUSH_WIPE STARTX=237 STARTY=1 TIMES=5
  
  # Move to the starting position
  # G1 X{start_x} Y{start_y} F3000

  {% set x_step = width / 2 %}  ; Define X zig width (half range if alternating)
  {% set x_left = start_x + width %}
  {% set x_right = start_x + width + x_step * 2 %}
  {% set y_step = depth / loops %}
  
  {% for zigzag in range(loops + 1) %}
     {% set y_pos = start_y + zigzag * y_step %}
     {% if zigzag % 2 == 0 %}
        {% set x_pos = x_left %}
     {% else %}
        {% set x_pos = x_right %}
     {% endif %}
     RESPOND MSG="G1 X{x_pos} Y{y_pos} F{speed * 60}"
  {% endfor %}
  
  #G1 X{start_x} Y{middle_y} F{wipe_spd * 60}


  # RESPOND MSG="

  # Step 4: Return to original position
  #RESPOND PREFIX="end  "  MSG="G1 X{pos_start_x} Y{pos_start_y} F6000"

[toolchanger]
t_command_restore_axis: XYZ   # why is this here and not in [tool tool_name] according to the documentation?
initialize_on: first-use
uses_axis: xy 

# Extra params to pass to pickup/dropoff gcode. Accessible in the gcode via `toolchanger.params_name`.
# Also will be copied to any tools for this toolchanger with local values overriding. 
params_safe_toolhead_y: 120  # safe motion while toolhead is present
params_safe_shuttle_y: 20  # safe motion with no toolhead present
params_close_y: 15   # Y position right before the magnets start to grab
params_attach_y: 2   # Y position matching the large opening of the slots
params_park_z: 237   # Z position when the screws are at the bottom of the slots
params_fast_speed: 36000 # Go as fast as we can # Was 30000
params_path_speed: 7200 # Was 1500
# Default shaper params
params_input_shaper_freq_x: 117.8
params_input_shaper_freq_y: 80.2

error_gcode:
  {% if printer["gcode_macro PAUSE_BASE"] is defined %} PAUSE_BASE {% else %} PAUSE {% endif %}

before_change_gcode:
  {% set tn = "T"+(tool.tool_number|string) %}
  {% if printer["gcode_macro " + tn ] %}
     SET_GCODE_VARIABLE MACRO={tn} VARIABLE=color VALUE="''"
  {% endif %}

after_change_gcode:
  {% set tn = "T"+(tool.tool_number|string) %}
  {% if printer["gcode_macro " + tn ] %}
     SET_GCODE_VARIABLE MACRO={tn} VARIABLE=color VALUE="'c44'"
  {% endif %}
  {% if tool.params_input_shaper_freq_x %}
    SET_INPUT_SHAPER SHAPER_TYPE_X={tool.params_input_shaper_type_x} SHAPER_FREQ_X={tool.params_input_shaper_freq_x} SHAPER_TYPE_Y={tool.params_input_shaper_type_y} SHAPER_FREQ_Y={tool.params_input_shaper_freq_y}
  {% endif %}

dropoff_gcode:
  {% set park_x = tool.params_park_x|float %}
  {% set detach_x = tool.params_detach_x|float %}
  {% set fast = tool.params_fast_speed|float %}
  {% set max_z = printer.configfile.config["stepper_z"]["position_max"]|float %}
  {% set cur_z = printer.toolhead.position[2]|float %}
  RESPOND PREFIX=üì§ MSG="Dropping off {tool.name}"
  G90
  
  G0 Z{ [cur_z+5.0, max_z]|min } F{fast} ;  Move 5 mm up to avoid crashing into things

  G0 X{detach_x} Y{tool.params_safe_toolhead_y} F{fast}
  G0 Y{tool.params_attach_y} F{fast}

  G0 X{park_x} F{tool.params_path_speed}
  G0 Y{tool.params_close_y} F{tool.params_path_speed}
  G0 Y{tool.params_safe_shuttle_y} F{fast}

pickup_gcode:
  {% set park_x = tool.params_park_x|float %}
  {% set detach_x = tool.params_detach_x|float %}
  {% set fast = tool.params_fast_speed|float %}
  
  RESPOND PREFIX=üì§ MSG="Picking up {tool.name}"
  G90
 
  G0 Y{tool.params_safe_shuttle_y} F{fast}
  G0 X{park_x} F{fast}
  G0 Y{tool.params_close_y} F{fast}
  {% if tool.extruder %} M109 T{tool.tool_number} S{printer[tool.extruder].target|int} {% endif %}

  G0 Y{tool.params_attach_y} F{tool.params_path_speed}
  G0 X{detach_x} F{tool.params_path_speed}
  
  # HotSnot Part     #
  {% if tool.extruder and printer.print_stats.state == "printing" %}
    SET_STEPPER_ENABLE STEPPER={tool.extruder} ENABLE=1
    RESPOND PREFIX=ü§ß MSG="HotSnot ing {tool.name}"
    {% if (printer.extruder.can_extrude|lower != 'true')%}
      RESPOND PREFIX=‚ùÑÔ∏èÔøΩ MSG="Extruder {printer[tool.extruder]} not hot enough"
    {% else %}  
      #{% set backup_fan_speed = printer.fan.speed %}
      M106 S255     ; 100%
      #{% set backup_feedrate = printer.gcode_move.speed_factor %}
      #M220 S100
      M83
      G1 E4.2 F1200 ; Orca pre Toolswap retract: Length when switching Filament (5) - Retraction (0.8)
      G1 E5 F600    ; purge amount
      G4 P1000      ; 1s wait
      G1 E-5 F1200  ; Orcaextrude: Length when switching Filament (5)

      #G91
      #{park_x} {detach_x}

      G90
      #M106 S{(backup_fan_speed * 255)|int}
      #M220 S{(backup_feedrate * 100)|int}
    {% endif %}
  {% endif %}
  ####################
  G0 Y{tool.params_safe_toolhead_y} F{fast}

  {% if 'Z' in restore_position %} G0 Z{restore_position.Z} F{fast} {% endif %}
  {% if 'X' in restore_position %} G0 X{restore_position.X} F{fast} {% endif %}
  {% if 'Y' in restore_position %} G0 Y{restore_position.Y} F{fast} {% endif %}


[gcode_macro _INITIALIZE_FROM_DETECTED_TOOL]
gcode:
  DETECT_ACTIVE_TOOL_PROBE
  _INITIALIZE_FROM_DETECTED_TOOL_IMPL

[gcode_macro _INITIALIZE_FROM_DETECTED_TOOL_IMPL]
gcode:
  {% if printer.tool_probe_endstop.active_tool_number | int == -1 %}
    RESPOND TYPE=error MSG='Failed to detect active tool'
    PAUSE
  {% else %}
    { action_respond_info('initialize from detected tool')}
    INITIALIZE_TOOLCHANGER T={printer.tool_probe_endstop.active_tool_number}
  {% endif %}

[delayed_gcode _SETUP_TOOLCHANGER_ONBOOT]
initial_duration: 6
gcode: 
  _SETUP_TOOLCHANGER
  
[gcode_macro _SETUP_TOOLCHANGER]
gcode: 
  INITIALIZE_TOOLCHANGER
  G4 P500
  _INITIALIZE_FROM_DETECTED_TOOL